<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø§Ø³Ø¨Ø© Ø£Ø±Ø¨Ø§Ø­ FC 26</title>
    <style>
        /* 1. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† (Dark Theme) */
        :root {
            --bg-color: #121212; 
            --card-color: #1e1e1e; 
            --text-color: #e0e0e0; 
            --input-bg: #2e2e2e; 
            --border-color: #444;
            --profit-color: #66BB6A; 
            --loss-color: #EF5350;   
            --update-color: #FFC107; 
            --delete-color: #dc3545;
            --edit-color: #17a2b8;
            --view-color: #66BB6A; /* Ø£Ø²Ø±Ù‚ */
            --total-color: #007bff; 
            --buy-color: #ff9800; 
            --sell-color: #2196F3; 
            --pdf-button-color: #6c757d; 
            --reset-button-color: #dc3545; 
            --add-row-color: #17a2b8; 
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px 10px; 
            margin: 0;
            direction: rtl; 
        }

        #main-container {
            display: flex;
            flex-direction: column;
            gap: 20px; 
            width: 100%;
            max-width: 900px; 
        }
        
        .calculator, .saved-deals-container {
            background-color: var(--card-color);
            padding: 20px; 
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            width: 100%;
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ù…Ø© */
        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-sizing: border-box; 
            text-align: right;
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        button {
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-top: 5px;
            font-size: 0.9em;
            color: white; /* Ø¶Ù…Ø§Ù† Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø¨ÙŠØ¶ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        #addRowButton { background-color: var(--add-row-color); }
        #actionButton { background-color: var(--view-color); }
        #exportPdfButton { background-color: var(--pdf-button-color); }
        #resetAllDealsButton { background-color: var(--reset-button-color); }
        #cancelEditButton { background-color: var(--reset-button-color); }


        #actionButton, #exportPdfButton, #resetAllDealsButton {
            width: 100%;
            margin-top: 10px;
        }
        
        #addRowButton {
            width: 100%;
            margin-bottom: 20px;
        }

        /* --------------------------------- */
        /* ØªÙ†Ø³ÙŠÙ‚ ØµÙÙˆÙ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© */
        /* --------------------------------- */
        .input-row {
            display: flex;
            flex-wrap: wrap; 
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #242424;
            align-items: center; 
        }
        
        .input-row label {
             font-size: 0.8em;
             margin-bottom: 5px;
             color: #aaa;
             display: block; 
        }
        
        .input-group {
            flex: 1;
            min-width: 110px; 
        }
        
        .input-group.name-field {
            flex: 2; 
            min-width: 130px; 
        }
        
        /* Ø²Ø± Ø­Ø°Ù Ø§Ù„ØµÙ Ø§Ù„ÙØ±Ø¹ÙŠ */
        .remove-row-btn {
            background-color: var(--delete-color);
            color: white;
            width: 60px; 
            height: 40px; 
            padding: 0 5px; 
            margin: 0;
            flex-shrink: 0;
            font-size: 0.8em; 
            margin-top: 0; 
        }

        /* --------------------------------- */
        /* ØªØµÙ…ÙŠÙ… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© */
        /* --------------------------------- */
        .deal-item {
            display: flex;
            flex-direction: column; 
            justify-content: space-between;
            align-items: flex-start; 
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #242424;
        }
        
        .deal-actions {
            display: flex;
            gap: 5px; 
            width: 100%; 
        }
        
        .deal-actions button {
            flex: 1; 
            width: auto; 
            font-size: 0.85em; 
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© */
        .view-details-btn {
            background-color: var(--view-color);
        }
        .edit-btn {
            background-color: var(--edit-color);
        }
        .delete-btn {
            background-color: var(--delete-color);
        }
        
        .deal-info {
            flex-grow: 1; 
            margin-bottom: 10px;
        }

        .deal-profit {
            font-size: 1.1em;
            font-weight: bold;
            display: block; 
            margin-bottom: 10px;
        }
        
        .deal-info p {
            font-size: 0.9em;
            margin: 5px 0 0;
            color: #ccc;
        }
        
        .sub-deal-details {
            margin-top: 15px;
            padding: 10px;
            background-color: #2a2a2a;
            border-radius: 6px;
            display: none; 
            width: 100%; 
        }
        
        .sub-deal-details h4 {
            margin-top: 0;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
            color: var(--total-color);
        }
        
        .sub-deal-row {
            font-size: 0.85em;
            padding: 3px 0;
            border-bottom: 1px dotted #333;
        }
        .sub-deal-row:last-child {
            border-bottom: none;
        }

        /* --------------------------------- */
        /* Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„ÙˆØ³Ø§Ø¦Ø· (Media Query) Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø£ÙƒØ¨Ø± */
        /* --------------------------------- */
        @media (min-width: 600px) {
            .input-row {
                flex-wrap: nowrap;
            }
            .deal-item {
                flex-direction: row; 
                align-items: center; 
            }
            .deal-info { margin-bottom: 0; }
            .deal-profit {
                display: inline-block;
                margin-left: 20px;
                margin-right: 20px;
                min-width: 120px; 
                text-align: right;
            }
            .deal-actions {
                width: auto;
                gap: 5px;
                margin-right: 10px;
            }
            .deal-actions button {
                flex: none; 
                width: 90px; 
            }
        }
        
        .summary-box {
            background-color: #242424; 
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            border-top: 3px solid var(--total-color);
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted #3a3a3a;
        }
        .summary-value {
            font-weight: bold;
        }
        
        .profit { color: var(--profit-color); }
        .loss { color: var(--loss-color); }

        /* --------------------------------- */
        /* 3. ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ù„Ù€ PDF) */
        /* --------------------------------- */
        @media print {
            .calculator, #noDealsMessage, .deal-actions, #exportPdfButton, #cancelEditButton, #actionButton, #resetAllDealsButton, #addRowButton, .remove-row-btn {
                display: none !important; 
            }
            
            .sub-deal-details {
                display: block !important;
                background-color: #f0f0f0 !important;
                border: 1px solid #ddd !important;
                color: #333 !important;
                -webkit-print-color-adjust: exact; 
                color-adjust: exact;
            }
            
            body, #main-container, .saved-deals-container {
                background-color: white !important;
                color: #333 !important; 
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 auto !important;
            }
        }
    </style>
</head>
<body>

<div id="main-container">
    <div class="calculator">
        <h2>ğŸ’° Ø­Ø§Ø³Ø¨Ø© Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©</h2>
        
        <div>
            <label for="dealName">Ø§Ø³Ù… Ø§Ù„ØµÙÙ‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <input type="text" id="dealName" placeholder="Ù…Ø«Ø§Ù„: ØµÙÙ‚Ø§Øª TOTW Ùˆ ØªØ±Ù‚ÙŠØ§Øª Ø§Ù„Ø¯ÙˆØ±ÙŠ">
        </div>

        <hr style="border-color: var(--border-color); margin: 20px 0;">

        <div id="dynamicInputContainer">
            </div>

        <button id="addRowButton" onclick="addRow()">+ Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨/ØµÙÙ‚Ø© ÙØ±Ø¹ÙŠØ©</button>

        <div class="result" id="results">
            <p><strong>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (5%):</strong> <span id="netRevenue">0</span> ÙƒÙˆÙŠÙ†Ø²</p>
            <p><strong>Ø§Ù„Ø±Ø¨Ø­ / Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„ØµØ§ÙÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©:</strong> <span id="netProfit" class="profit">0</span> ÙƒÙˆÙŠÙ†Ø²</p>
        </div>
        
        <button id="actionButton" class="saving" onclick="handleAction()">Ø­ÙØ¸ Ø§Ù„ØµÙÙ‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button id="cancelEditButton" onclick="cancelEdit()" style="display: none;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø­ÙØ¸</button>
    </div>

    <div class="saved-deals-container">
        <h2>ğŸ“‚ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©)</h2>
        <ul id="savedDealsList">
            </ul>
        <p id="noDealsMessage" style="text-align: center; color: #888;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯.</p>

        <div id="summaryBox" class="summary-box" style="display: none;">
            <h3>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</h3>
            <div class="summary-item">
                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ÙƒÙ„ÙŠØ©:</span>
                <span id="totalBuy" class="summary-value buy">0 ÙƒÙˆÙŠÙ†Ø²</span>
            </div>
             <div class="summary-item">
                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„ÙƒÙ„ÙŠ (Ø§Ù„Ø®Ø§Ù…):</span>
                <span id="totalSell" class="summary-value sell">0 ÙƒÙˆÙŠÙ†Ø²</span>
            </div>
            <div class="summary-item">
                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
                <span id="totalNetRevenue" class="summary-value sell">0 ÙƒÙˆÙŠÙ†Ø²</span>
            </div>
            <div class="summary-item">
                <span>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ / Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                <span id="totalProfitValue" class="summary-value profit">0 ÙƒÙˆÙŠÙ†Ø²</span>
            </div>
        </div>
        
        <button id="exportPdfButton" onclick="exportToPdf()">ğŸ“¥ ØªØµØ¯ÙŠØ± ÙƒÙ…Ù„Ù PDF Ù…ÙØµÙ„</button>
        <button id="resetAllDealsButton" onclick="resetAllDeals()">âš ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙ‚Ø§Øª</button>
    </div>
</div>

<script>
    const STORAGE_KEY = 'fc26_saved_deals_v4'; 
    const TAX_RATE = 0.05;
    let editingDealId = null;

    // ------------------------------------
    // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
    // ------------------------------------
    window.addRow = function(deal = null) {
        const container = document.getElementById('dynamicInputContainer');
        const rowId = deal ? deal.id : Date.now(); 
        
        const row = document.createElement('div');
        row.className = 'input-row';
        row.setAttribute('data-row-id', rowId);

        const name = deal ? deal.name : '';
        const sellPrice = deal ? deal.sell : '';
        const buyPrice = deal ? deal.buy : '';
        const quantity = deal ? deal.qty : (deal ? '' : '1');

        row.innerHTML = `
            <div class="input-group name-field">
                <label>Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨/Ø§Ù„ØµÙÙ‚Ø©:</label>
                <input type="text" class="deal-name-input" value="${name}" placeholder="Ø§Ù„Ø§Ø³Ù… (ØµÙ„Ø§Ø­ØŒ Ù…Ø¨Ø§Ø¯Ù„Ø© 87)...">
            </div>
            <div class="input-group">
                <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ù„Ù„ÙˆØ­Ø¯Ø©:</label>
                <input type="number" class="sell-price-input" value="${sellPrice}" oninput="calculateProfit()" placeholder="Ø¨ÙŠØ¹" min="0" step="100">
            </div>
            <div class="input-group">
                <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù„ÙˆØ­Ø¯Ø©:</label>
                <input type="number" class="buy-price-input" value="${buyPrice}" oninput="calculateProfit()" placeholder="Ø´Ø±Ø§Ø¡" min="0" step="100">
            </div>
            <div class="input-group" style="flex: 0.7; min-width: 60px;">
                <label>Ø§Ù„Ø¹Ø¯Ø¯:</label>
                <input type="number" class="quantity-input" value="${quantity}" oninput="calculateProfit()" placeholder="Ø¹Ø¯Ø¯" min="1" step="1">
            </div>
            <button class="remove-row-btn" onclick="removeRow(this)">Ø­Ø°Ù</button>
        `;
        
        container.appendChild(row);

        if (!deal) {
            calculateProfit();
        }
        
        return row;
    }
    
    window.removeRow = function(button) {
        const row = button.closest('.input-row');
        row.remove();
        calculateProfit(); 
    }

    // ------------------------------------
    // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    // ------------------------------------
    
    window.toggleDealDetails = function(button) {
        const listItem = button.closest('.deal-item');
        const detailsDiv = listItem.querySelector('.sub-deal-details');
        
        if (detailsDiv.style.display === 'block') {
            detailsDiv.style.display = 'none';
            button.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„';
        } else {
            detailsDiv.style.display = 'block';
            button.textContent = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙØ§ØµÙŠÙ„';
        }
    }


    window.resetAllDeals = function() {
        if (confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§.')) {
            localStorage.removeItem(STORAGE_KEY);
            editingDealId = null;
            clearInputFields();
            renderDealsList();
            alert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙ‚Ø§Øª Ø¨Ù†Ø¬Ø§Ø­. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø­ÙØ¸ ØµÙÙ‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.');
        }
    }
    
    window.exportToPdf = function() {
        window.print();
    }

    function formatNumber(num) {
        if (isNaN(num) || num === null) return '0';
        return Math.round(num).toLocaleString('en-US');
    }

    function calculateProfit() {
        const rows = document.querySelectorAll('#dynamicInputContainer .input-row');
        let totalNetProfit = 0;
        let grandTotalSell = 0;
        let grandTotalBuy = 0;

        if (rows.length === 0) {
            document.getElementById('netRevenue').textContent = formatNumber(0);
            document.getElementById('netProfit').textContent = formatNumber(0);
            document.getElementById('netProfit').className = 'deal-profit';
            return { totalNetProfit: 0, totalSellPrice: 0, totalBuyPrice: 0, totalNetRevenue: 0 };
        }

        rows.forEach(row => {
            const sellPrice = parseFloat(row.querySelector('.sell-price-input').value) || 0;
            const buyPrice = parseFloat(row.querySelector('.buy-price-input').value) || 0;
            const quantity = parseInt(row.querySelector('.quantity-input').value) || 0;

            if (quantity > 0 && (sellPrice > 0 || buyPrice > 0)) {
                const totalSell = sellPrice * quantity;
                const totalBuy = buyPrice * quantity;
                const totalTax = totalSell * TAX_RATE;
                const netRevenue = totalSell - totalTax;
                const netProfit = netRevenue - totalBuy;

                grandTotalSell += totalSell;
                grandTotalBuy += totalBuy;
                totalNetProfit += netProfit;
            }
        });

        const totalNetRevenue = grandTotalSell * (1 - TAX_RATE);
        
        document.getElementById('netRevenue').textContent = formatNumber(totalNetRevenue);
        
        const netProfitElement = document.getElementById('netProfit');
        netProfitElement.textContent = formatNumber(totalNetProfit);

        if (totalNetProfit > 0) {
            netProfitElement.className = 'deal-profit profit';
        } else if (totalNetProfit < 0) {
            netProfitElement.className = 'deal-profit loss';
        } else {
            netProfitElement.className = 'deal-profit'; 
        }

        return { totalNetProfit, totalSellPrice: grandTotalSell, totalBuyPrice: grandTotalBuy, totalNetRevenue };
    }

    function getDealsFromStorage() {
        const storedDeals = localStorage.getItem(STORAGE_KEY);
        try {
            return storedDeals ? JSON.parse(storedDeals) : [];
        } catch (e) {
            console.error("Local Storage data corrupted, clearing saved deals.", e);
            localStorage.removeItem(STORAGE_KEY); 
            return [];
        }
    }
    
    function handleAction() {
        if (editingDealId) {
            updateDeal(editingDealId);
        } else {
            saveDeal();
        }
    }
    
    function saveDeal() {
        const { totalNetProfit, totalSellPrice, totalBuyPrice, totalNetRevenue } = calculateProfit();
        const rows = document.querySelectorAll('#dynamicInputContainer .input-row');

        if (rows.length === 0 || (totalSellPrice <= 0 && totalBuyPrice <= 0)) {
            alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© ØµÙÙ‚Ø© ÙØ±Ø¹ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø¨Ø£Ø³Ø¹Ø§Ø±.");
            return;
        }

        let dealName = document.getElementById('dealName').value.trim() || `ØµÙÙ‚Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© ØºÙŠØ± Ù…ÙØ³Ù…Ø§Ø© (${new Date().toLocaleTimeString('ar-EG')})`;
        
        const subDeals = Array.from(rows).map(row => ({
            id: row.getAttribute('data-row-id'),
            name: row.querySelector('.deal-name-input').value.trim() || 'ØºÙŠØ± Ù…ÙØ³Ù…Ù‰', 
            sell: parseFloat(row.querySelector('.sell-price-input').value) || 0,
            buy: parseFloat(row.querySelector('.buy-price-input').value) || 0,
            qty: parseInt(row.querySelector('.quantity-input').value) || 0,
        }));
        
        const newDeal = {
            id: Date.now(),
            name: dealName,
            subDeals: subDeals, 
            totalSell: totalSellPrice, 
            totalBuy: totalBuyPrice,   
            totalNetRevenue: totalNetRevenue,
            profit: totalNetProfit
        };

        const deals = getDealsFromStorage();
        deals.push(newDeal);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(deals));
        
        clearInputFields();
        renderDealsList();
    }
    
    window.updateDeal = function(idToUpdate) {
        const { totalNetProfit, totalSellPrice, totalBuyPrice, totalNetRevenue } = calculateProfit();
        const rows = document.querySelectorAll('#dynamicInputContainer .input-row');

        if (rows.length === 0 || (totalSellPrice <= 0 && totalBuyPrice <= 0)) {
            alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© ØµÙÙ‚Ø© ÙØ±Ø¹ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø¨Ø£Ø³Ø¹Ø§Ø±.");
            return;
        }
        
        let dealName = document.getElementById('dealName').value.trim() || `ØµÙÙ‚Ø© Ù…ÙØ¹Ø¯Ù„Ø© (${new Date().toLocaleTimeString('ar-EG')})`;

        const subDeals = Array.from(rows).map(row => ({
            id: row.getAttribute('data-row-id'),
            name: row.querySelector('.deal-name-input').value.trim() || 'ØºÙŠØ± Ù…ÙØ³Ù…Ù‰', 
            sell: parseFloat(row.querySelector('.sell-price-input').value) || 0,
            buy: parseFloat(row.querySelector('.buy-price-input').value) || 0,
            qty: parseInt(row.querySelector('.quantity-input').value) || 0,
        }));

        let deals = getDealsFromStorage();
        const index = deals.findIndex(deal => deal.id === idToUpdate);

        if (index !== -1) {
            deals[index] = {
                id: idToUpdate,
                name: dealName,
                subDeals: subDeals,
                totalSell: totalSellPrice,
                totalBuy: totalBuyPrice,
                totalNetRevenue: totalNetRevenue,
                profit: totalNetProfit
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(deals));
            
            cancelEdit(); 
            renderDealsList();
        } else {
            alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØµÙÙ‚Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ«.");
        }
    }

    window.editDeal = function(dealId) {
        const deals = getDealsFromStorage();
        const dealToEdit = deals.find(deal => deal.id === dealId);

        if (dealToEdit) {
            document.getElementById('dealName').value = dealToEdit.name;
            
            document.getElementById('dynamicInputContainer').innerHTML = '';
            dealToEdit.subDeals.forEach(subDeal => addRow({
                id: subDeal.id,
                name: subDeal.name || '', 
                sell: subDeal.sell,
                buy: subDeal.buy,
                qty: subDeal.qty
            }));

            calculateProfit();

            editingDealId = dealId;
            const actionButton = document.getElementById('actionButton');
            actionButton.textContent = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙÙ‚Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©';
            actionButton.classList.remove('saving');
            actionButton.classList.add('updating');
            
            document.getElementById('cancelEditButton').style.display = 'block';
        }
    }

    window.cancelEdit = function() {
        editingDealId = null;
        const actionButton = document.getElementById('actionButton');
        actionButton.textContent = 'Ø­ÙØ¸ Ø§Ù„ØµÙÙ‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©';
        actionButton.classList.remove('updating');
        actionButton.classList.add('saving');
        
        document.getElementById('cancelEditButton').style.display = 'none';
        clearInputFields();
    }
    
    function clearInputFields() {
        document.getElementById('dealName').value = '';
        document.getElementById('dynamicInputContainer').innerHTML = ''; 
        addRow(); 
        calculateProfit();
    }

    function renderDealsList() {
        const deals = getDealsFromStorage();
        const list = document.getElementById('savedDealsList');
        const message = document.getElementById('noDealsMessage');
        const summaryBox = document.getElementById('summaryBox');

        list.innerHTML = '';
        
        let totalProfit = 0;
        let grandTotalBuy = 0;
        let grandTotalSell = 0;
        let grandTotalNetRevenue = 0;

        if (deals.length === 0) {
            message.style.display = 'block';
            summaryBox.style.display = 'none';
        } else {
            message.style.display = 'none';
            summaryBox.style.display = 'block';
        }

        deals.forEach(deal => {
            
            if (deal.totalSell === undefined) { return; } 
            
            const profitValue = deal.profit;
            
            totalProfit += deal.profit; 
            grandTotalBuy += deal.totalBuy; 
            grandTotalSell += deal.totalSell;
            grandTotalNetRevenue += deal.totalNetRevenue;

            const listItem = document.createElement('li');
            listItem.className = 'deal-item';
            
            const profitClass = profitValue > 0 ? 'profit' : (profitValue < 0 ? 'loss' : '');
            const profitSign = Math.sign(profitValue) >= 0 ? '+' : ''; 
            
            const subDealCount = deal.subDeals ? deal.subDeals.length : 0;
            
            let subDealsHtml = '';
            if (subDealCount > 0) {
                subDealsHtml = `
                    <div class="sub-deal-details">
                        <h4>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© (${subDealCount} ØµÙÙ‚Ø©)</h4>
                        ${deal.subDeals.map(sub => {
                            const netSell = sub.sell * sub.qty * (1 - TAX_RATE);
                            const netBuy = sub.buy * sub.qty;
                            const subProfit = netSell - netBuy;
                            const subProfitClass = subProfit > 0 ? 'profit' : (subProfit < 0 ? 'loss' : '');
                            const subProfitSign = Math.sign(subProfit) >= 0 ? '+' : '';
                            
                            return `
                                <div class="sub-deal-row">
                                    <span style="font-weight: bold;">${sub.name || 'ØºÙŠØ± Ù…ÙØ³Ù…Ù‰'} (${formatNumber(sub.qty)}):</span>
                                    Ø¨ÙŠØ¹: ${formatNumber(sub.sell)} | Ø´Ø±Ø§Ø¡: ${formatNumber(sub.buy)} | 
                                    Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ: <span class="${subProfitClass}">${subProfitSign}${formatNumber(subProfit)}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            listItem.innerHTML = `
                <div class="deal-info">
                    <strong>${deal.name}</strong>
                    <p>
                        Ø¨ÙŠØ¹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø®Ø§Ù…: ${formatNumber(deal.totalSell)} | ØªÙƒÙ„ÙØ© Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: ${formatNumber(deal.totalBuy)}
                    </p>
                </div>
                <span class="deal-profit ${profitClass}">
                    ${profitSign}${formatNumber(profitValue)} ÙƒÙˆÙŠÙ†Ø²
                </span>
                <div class="deal-actions">
                    <button class="view-details-btn" onclick="toggleDealDetails(this)">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
                    <button class="edit-btn" onclick="editDeal(${deal.id})">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="delete-btn" onclick="deleteDeal(${deal.id})">Ø­Ø°Ù</button>
                </div>
                ${subDealsHtml} 
            `;
            list.appendChild(listItem);
        });

        document.getElementById('totalBuy').textContent = `${formatNumber(grandTotalBuy)} ÙƒÙˆÙŠÙ†Ø²`;
        document.getElementById('totalSell').textContent = `${formatNumber(grandTotalSell)} ÙƒÙˆÙŠÙ†Ø²`;
        document.getElementById('totalNetRevenue').textContent = `${formatNumber(grandTotalNetRevenue)} ÙƒÙˆÙŠÙ†Ø²`;

        const totalProfitValueElement = document.getElementById('totalProfitValue');
        const totalClass = totalProfit > 0 ? 'profit' : (totalProfit < 0 ? 'loss' : '');
        const totalSign = Math.sign(totalProfit) >= 0 ? '+' : ''; 
        
        totalProfitValueElement.textContent = `${totalSign}${formatNumber(totalProfit)} ÙƒÙˆÙŠÙ†Ø²`;
        totalProfitValueElement.className = `summary-value ${totalClass}`;
    }

    window.deleteDeal = function(dealId) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØµÙÙ‚Ø©ØŸ')) {
            return;
        }
        
        let deals = getDealsFromStorage();
        deals = deals.filter(deal => deal.id !== dealId);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(deals));
        renderDealsList();
        
        if (editingDealId === dealId) {
            cancelEdit();
        }
    }

    window.onload = () => {
        if (document.querySelectorAll('#dynamicInputContainer .input-row').length === 0) {
             addRow();
        }
        calculateProfit();
        renderDealsList();
    };
</script>

</body>
</html>
